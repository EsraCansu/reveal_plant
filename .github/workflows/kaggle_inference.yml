name: Kaggle Model Inference

on:
  push:
    branches: [ main, master ]
    paths:
      - 'test_images/**'
      - 'kaggle_notebook/**'
      - '.github/workflows/kaggle_inference.yml'
  workflow_dispatch:
    inputs:
      test_image:
        description: 'Test gÃ¶rseli adÄ± (Ã¶rn: dom.jpg veya uzum.jpg)'
        required: false
        default: 'dom.jpg'

jobs:
  run-inference:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ Checkout Repository
      uses: actions/checkout@v3
    
    - name: ðŸ Python Kurulumu
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ðŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        pip install --upgrade pip
        pip install kaggle
    
    - name: ðŸ”‘ Kaggle Credentials Ayarla
      env:
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
      run: |
        mkdir -p ~/.kaggle
        echo "{\"username\":\"$KAGGLE_USERNAME\",\"key\":\"$KAGGLE_KEY\"}" > ~/.kaggle/kaggle.json
        chmod 600 ~/.kaggle/kaggle.json
        echo "âœ“ Kaggle credentials ayarlandÄ±"
    
    - name: ðŸ–¼ï¸ Test GÃ¶rselini HazÄ±rla
      run: |
        if [ -n "${{ github.event.inputs.test_image }}" ]; then
          IMAGE_NAME="${{ github.event.inputs.test_image }}"
        else
          IMAGE_NAME="dom.jpg"
        fi
        
        if [ -f "test_images/$IMAGE_NAME" ]; then
          # Dosya uzantÄ±sÄ±nÄ± al
          EXT="${IMAGE_NAME##*.}"
          cp "test_images/$IMAGE_NAME" "kaggle_notebook/test_image.$EXT"
          echo "âœ“ Test gÃ¶rseli kopyalandÄ±: $IMAGE_NAME -> test_image.$EXT"
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
        else
          echo "âš ï¸ GÃ¶rsel bulunamadÄ±: test_images/$IMAGE_NAME"
          echo "Mevcut gÃ¶rseller:"
          ls -la test_images/ || echo "test_images klasÃ¶rÃ¼ bulunamadÄ±"
          exit 1
        fi
    
    - name: ðŸ“‹ Notebook KontrolÃ¼
      run: |
        echo "Kaggle notebook iÃ§eriÄŸi:"
        ls -la kaggle_notebook/
        
        if [ ! -f "kaggle_notebook/notebook.ipynb" ]; then
          echo "âš ï¸ notebook.ipynb bulunamadÄ±!"
          exit 1
        fi
        
        if [ ! -f "kaggle_notebook/kernel-metadata.json" ]; then
          echo "âš ï¸ kernel-metadata.json bulunamadÄ±!"
          exit 1
        fi
        
        echo "âœ“ Gerekli dosyalar mevcut"
    
    - name: ðŸš€ Kaggle'a Notebook GÃ¶nder
      run: |
        cd kaggle_notebook
        echo "Notebook Kaggle'a gÃ¶nderiliyor..."
        kaggle kernels push
        echo "âœ“ Notebook gÃ¶nderildi"
    
    - name: â³ Notebook Ã‡alÄ±ÅŸmasÄ±nÄ± Bekle
      run: |
        echo "Notebook'un Ã§alÄ±ÅŸmasÄ± bekleniyor..."
        KERNEL_SLUG="muhammetyusufyilmaz/reveal-plant-inference"
        
        for i in {1..20}; do
          echo "Kontrol $i/20..."
          
          STATUS=$(kaggle kernels status $KERNEL_SLUG 2>&1 || echo "error")
          
          if echo "$STATUS" | grep -q "complete"; then
            echo "âœ“ Notebook tamamlandÄ±!"
            break
          elif echo "$STATUS" | grep -q "error\|failed"; then
            echo "âš ï¸ Notebook hata verdi!"
            echo "$STATUS"
            exit 1
          else
            echo "  Durum: Ã§alÄ±ÅŸÄ±yor... ($i x 15s = $((i*15))s)"
            sleep 15
          fi
          
          if [ $i -eq 20 ]; then
            echo "âš ï¸ Timeout! Notebook 5 dakikada tamamlanmadÄ±."
            echo "Son durum: $STATUS"
            exit 1
          fi
        done
    
    - name: ðŸ“¥ SonuÃ§larÄ± Ä°ndir
      run: |
        echo "SonuÃ§lar indiriliyor..."
        mkdir -p results
        
        # Notebook output'unu indir
        kaggle kernels output muhammetyusufyilmaz/reveal-plant-inference -p results/
        
        echo "Ä°ndirilen dosyalar:"
        ls -la results/
    
    - name: ðŸ“Š SonuÃ§larÄ± GÃ¶ster
      run: |
        if [ -f "results/predictions.json" ]; then
          echo "âœ… TAHMIN SONUÃ‡LARI:"
          echo ""
          cat results/predictions.json | python3 -m json.tool
        else
          echo "âš ï¸ predictions.json bulunamadÄ±"
          echo "Ä°ndirilen dosyalar:"
          ls -la results/
          exit 1
        fi
    
    - name: ðŸ’¾ SonuÃ§larÄ± Kaydet
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: inference-results-${{ github.run_number }}
        path: |
          results/
          kaggle_notebook/test_image.*
        retention-days: 30

    - name: ðŸ“ Workflow Summary OluÅŸtur
      if: always()
      run: |
        echo "# ðŸŒ± Reveal Plant - Model Inference Raporu" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Test GÃ¶rseli:** \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Tarih:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "results/predictions.json" ]; then
          echo "## ðŸ“Š Tahmin SonuÃ§larÄ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat results/predictions.json >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ SonuÃ§ bulunamadÄ±" >> $GITHUB_STEP_SUMMARY
        fi