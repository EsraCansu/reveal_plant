/*
 * WebSocket Test Suite for Reveal Plant
 * This HTML page tests WebSocket connectivity and real-time prediction
 */

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket Test - Reveal Plant</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        h1 { color: #2c3e50; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-section h2 { color: #34495e; margin-top: 0; }
        .status { padding: 10px; margin: 5px 0; border-radius: 3px; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .test-button { padding: 10px 20px; margin: 5px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .test-button:hover { background: #2980b9; }
        .log { background: #f8f9fa; padding: 10px; margin: 5px 0; border-left: 3px solid #3498db; font-family: monospace; font-size: 12px; overflow-x: auto; }
        textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Reveal Plant - WebSocket Test Suite</h1>

        <!-- Test 1: FastAPI Health -->
        <div class="test-section">
            <h2>1Ô∏è‚É£ FastAPI Health Check</h2>
            <button class="test-button" onclick="testFastAPIHealth()">Test FastAPI Health</button>
            <div id="fastapi-health"></div>
        </div>

        <!-- Test 2: Frontend Assets -->
        <div class="test-section">
            <h2>2Ô∏è‚É£ Frontend Assets</h2>
            <button class="test-button" onclick="testFrontendAssets()">Test Assets</button>
            <div id="frontend-assets"></div>
        </div>

        <!-- Test 3: WebSocket Connection -->
        <div class="test-section">
            <h2>3Ô∏è‚É£ WebSocket Connection</h2>
            <button class="test-button" onclick="connectWebSocket()">Connect WebSocket</button>
            <button class="test-button" onclick="disconnectWebSocket()">Disconnect</button>
            <div id="websocket-status"></div>
        </div>

        <!-- Test 4: Send Prediction Request -->
        <div class="test-section">
            <h2>4Ô∏è‚É£ Send Prediction Request</h2>
            <p>User ID: <input type="number" id="userId" value="1" style="width: 50px;"></p>
            <p>Plant ID: <input type="number" id="plantId" value="5" style="width: 50px;"></p>
            <p>Description: <input type="text" id="description" value="Yellow spots on leaves" style="width: 300px;"></p>
            <button class="test-button" onclick="sendTestPrediction()">Send Prediction</button>
            <div id="prediction-response"></div>
        </div>

        <!-- Test 5: Message Log -->
        <div class="test-section">
            <h2>5Ô∏è‚É£ Message Log</h2>
            <button class="test-button" onclick="clearLog()">Clear Log</button>
            <div id="message-log" style="max-height: 400px; overflow-y: auto;"></div>
        </div>

        <!-- Test 6: Sample Base64 Image -->
        <div class="test-section">
            <h2>6Ô∏è‚É£ Test with Sample Image</h2>
            <p>Paste a valid base64 encoded image (data:image/jpeg;base64,...)</p>
            <textarea id="imageBase64" placeholder="Paste base64 image data here..."></textarea>
            <button class="test-button" onclick="sendImagePrediction()">Send Image Prediction</button>
        </div>
    </div>

    <script>
        let stompClient = null;
        const logDiv = document.getElementById('message-log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const log = document.createElement('div');
            log.className = `log`;
            log.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(log);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            logDiv.innerHTML = '';
        }

        function displayStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.textContent = message;
            element.appendChild(status);
        }

        // Test 1: FastAPI Health
        async function testFastAPIHealth() {
            const element = document.getElementById('fastapi-health');
            element.innerHTML = '';
            try {
                log('Testing FastAPI health endpoint...');
                const response = await fetch('http://localhost:8000/health');
                const data = await response.json();
                displayStatus('fastapi-health', `‚úÖ FastAPI is running - Model loaded: ${data.model_loaded}`, 'success');
                log(`FastAPI response: ${JSON.stringify(data)}`);
            } catch (error) {
                displayStatus('fastapi-health', `‚ùå FastAPI error: ${error.message}`, 'error');
                log(`FastAPI error: ${error.message}`);
            }
        }

        // Test 2: Frontend Assets
        async function testFrontendAssets() {
            const element = document.getElementById('frontend-assets');
            element.innerHTML = '';
            const assets = [
                { name: 'HTML', url: 'http://localhost:3000' },
                { name: 'CSS', url: 'http://localhost:3000/assets/css/style.css' },
                { name: 'JavaScript', url: 'http://localhost:3000/assets/js/app.js' }
            ];

            for (const asset of assets) {
                try {
                    const response = await fetch(asset.url);
                    if (response.ok) {
                        displayStatus('frontend-assets', `‚úÖ ${asset.name}: ${response.status}`, 'success');
                        log(`${asset.name} loaded successfully`);
                    } else {
                        displayStatus('frontend-assets', `‚ö†Ô∏è ${asset.name}: ${response.status}`, 'error');
                        log(`${asset.name} returned status ${response.status}`);
                    }
                } catch (error) {
                    displayStatus('frontend-assets', `‚ùå ${asset.name}: ${error.message}`, 'error');
                    log(`${asset.name} error: ${error.message}`);
                }
            }
        }

        // Test 3: WebSocket Connection
        function connectWebSocket() {
            const element = document.getElementById('websocket-status');
            element.innerHTML = '';
            
            try {
                log('Connecting to WebSocket...');
                const socket = new SockJS('http://localhost:8080/ws/predictions');
                stompClient = Stomp.over(socket);

                stompClient.connect({}, (frame) => {
                    log('WebSocket connected: ' + frame.command);
                    displayStatus('websocket-status', '‚úÖ WebSocket Connected', 'success');

                    // Subscribe to test channels
                    stompClient.subscribe('/user/1/queue/predictions', (message) => {
                        const data = JSON.parse(message.body);
                        log('Received prediction: ' + JSON.stringify(data));
                        displayStatus('prediction-response', `‚úÖ Prediction received: ${data.diseaseName}`, 'success');
                    });

                    stompClient.subscribe('/user/1/queue/status', (message) => {
                        const data = JSON.parse(message.body);
                        log('Status update: ' + data.status + ' - ' + data.message);
                    });

                    stompClient.subscribe('/topic/predictions', (message) => {
                        const data = JSON.parse(message.body);
                        log('Broadcast prediction: ' + JSON.stringify(data));
                    });
                }, (error) => {
                    log('WebSocket connection error: ' + error);
                    displayStatus('websocket-status', `‚ùå Connection error: ${error}`, 'error');
                });
            } catch (error) {
                log('WebSocket error: ' + error.message);
                displayStatus('websocket-status', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        function disconnectWebSocket() {
            if (stompClient && stompClient.connected) {
                stompClient.disconnect(() => {
                    log('WebSocket disconnected');
                    displayStatus('websocket-status', '‚èπÔ∏è Disconnected', 'info');
                });
            }
        }

        // Test 4: Send Prediction
        function sendTestPrediction() {
            if (!stompClient || !stompClient.connected) {
                displayStatus('prediction-response', '‚ùå WebSocket not connected', 'error');
                log('WebSocket not connected');
                return;
            }

            const userId = document.getElementById('userId').value;
            const plantId = document.getElementById('plantId').value;
            const description = document.getElementById('description').value;

            // Create a simple test base64 image
            const testImageBase64 = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAn/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8VAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCwAA//9k=';

            const request = {
                userId: parseInt(userId),
                plantId: parseInt(plantId),
                imageBase64: testImageBase64,
                description: description,
                requestedAt: new Date().toISOString()
            };

            try {
                log('Sending prediction request: ' + JSON.stringify(request));
                stompClient.send(
                    `/app/predict/${userId}`,
                    {},
                    JSON.stringify(request)
                );
                displayStatus('prediction-response', 'üì§ Request sent', 'info');
            } catch (error) {
                log('Error sending prediction: ' + error.message);
                displayStatus('prediction-response', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Test 6: Send Image Prediction
        function sendImagePrediction() {
            if (!stompClient || !stompClient.connected) {
                displayStatus('prediction-response', '‚ùå WebSocket not connected', 'error');
                return;
            }

            const imageBase64 = document.getElementById('imageBase64').value;
            if (!imageBase64) {
                displayStatus('prediction-response', '‚ùå Please provide base64 image', 'error');
                return;
            }

            const userId = document.getElementById('userId').value;
            const plantId = document.getElementById('plantId').value;

            const request = {
                userId: parseInt(userId),
                plantId: parseInt(plantId),
                imageBase64: imageBase64,
                description: 'Test image from WebSocket test suite',
                requestedAt: new Date().toISOString()
            };

            try {
                log('Sending image prediction...');
                stompClient.send(`/app/predict/${userId}`, {}, JSON.stringify(request));
                displayStatus('prediction-response', 'üì§ Image sent for prediction', 'info');
            } catch (error) {
                log('Error sending image: ' + error.message);
                displayStatus('prediction-response', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            log('Page loaded - Ready for testing');
            log('Available tests:');
            log('1. FastAPI Health Check');
            log('2. Frontend Assets');
            log('3. WebSocket Connection');
            log('4. Send Prediction Request');
            log('5. Test with Custom Image');
        });
    </script>
</body>
</html>
